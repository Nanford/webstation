{% extends "base.html" %}

{% block title %}eBay店铺监控 - 监控面板{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i> eBay店铺监控系统
                </h2>
                <button id="refreshDashboardBtn" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> 刷新数据
                </button>
            </div>
            <div id="statusMessage" class="alert d-none mt-3"></div>
        </div>
    </div>
    
    <!-- 店铺列表 -->
    <div class="card mt-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-store me-2"></i>监控店铺列表</h5>
        </div>
        <div class="card-body">
            {% if stores %}
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>店铺名称</th>
                            <th>商品数量</th>
                            <th>最后更新</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for store in stores %}
                        <tr>
                            <td>{{ store.name }}</td>
                            <td>{{ store.items_count }}</td>
                            <td>{% if store.last_update %}{{ store.last_update|timestamp_to_date }}{% else %}未知{% endif %}</td>
                            <td>
                                <a href="{{ url_for('main.dashboard', store_name=store.name) }}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i> 查看商品
                                </a>
                                <button class="btn btn-sm btn-danger delete-store" data-store-id="{{ store.name }}">
                                    <i class="fas fa-trash"></i> 删除监控
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="alert alert-info">
                    <p><i class="fas fa-info-circle me-2"></i> 暂无监控店铺数据</p>
                    <p>您可以点击右上角的"添加店铺"按钮来添加一个eBay店铺进行监控</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 店铺详情内容 -->
    {% if selected_store %}
        <!-- 价格分布图 -->
        <div class="card mt-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>价格分布</h5>
                <span class="badge bg-primary">总计: {{ selected_store.items_count }} 商品</span>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 商品列表 -->
        <div class="card mt-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>商品列表</h5>
                <button id="refreshItemsBtn" class="btn btn-sm btn-primary">
                    <i class="fas fa-sync"></i> 刷新
                </button>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>图片</th>
                            <th>标题</th>
                            <th class="price-col">价格</th>
                            <th>状态</th>
                            <th>购买方式</th>
                            <th>运费</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in selected_store.items_list %}
                        <tr>
                            <td>
                                <img src="{{ item.image_url|default('/static/img/no-image.png') }}" 
                                     alt="{{ item.title|truncate(30) }}" 
                                     class="item-thumbnail" 
                                     onerror="this.src='/static/img/no-image.png'">
                            </td>
                            <td>
                                <a href="{{ item.url }}" target="_blank" title="{{ item.title }}">
                                    {{ item.title|truncate(40) }}
                                </a>
                            </td>
                            <td class="price-col">
                                <span class="hover-info">${{ item.price }}</span>
                            </td>
                            <td>
                                <span class="hover-info">{{ item.status|default('未知') }}</span>
                            </td>
                            <td>
                                <span class="hover-info">{{ item.buy_format|default('未知') }}</span>
                            </td>
                            <td>
                                <span class="hover-info">{{ item.shipping|default('未知') }}</span>
                            </td>
                            <td>
                                <a href="{{ item.url }}" class="btn btn-sm btn-primary" target="_blank">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
    
    <!-- 页脚 -->
    <div class="footer mt-4 mb-3 text-center">
        <p>© 2025 eBay店铺监控</p>
        <p class="text-info">
            {% if last_update_time %}
                最后更新: {{ last_update_time|timestamp_to_date }}
            {% else %}
                尚未更新
            {% endif %}
        </p>
        <p class="text-muted small">系统版本: 1.0.2</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if selected_store and selected_store.items_list %}
<script>
// 预先定义数据变量
var storeItems = JSON.parse('{{ selected_store.items_list|tojson|safe }}');
</script>
{% endif %}

<script>
$(document).ready(function() {
    // 删除监控按钮事件
    $('.delete-store').click(function() {
        var storeName = $(this).data('store-id');
        if (confirm('确定要删除对店铺 "' + storeName + '" 的监控吗？此操作不可撤销。')) {
            $.ajax({
                url: '/remove_store',
                method: 'POST',
                data: {
                    store_name: storeName
                },
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        // 删除成功后返回监控面板
                        window.location.href = '/dashboard';
                    } else {
                        alert('删除失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('服务器错误，请稍后再试');
                }
            });
        }
    });
    
    // 刷新数据按钮事件
    $('#refreshDashboardBtn').click(function() {
        var storeId = "{{ selected_store.name if selected_store else '' }}";
        if (!storeId) {
            alert('请先选择一个店铺');
            return;
        }
        
        var btn = $(this);
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 刷新中...');
        
        $.ajax({
            url: '/refresh_store',
            method: 'POST',
            data: {
                store_name: storeId
            },
            success: function(response) {
                if (response.success) {
                    $('#statusMessage').removeClass('d-none alert-danger').addClass('alert-success').text(response.message);
                    setTimeout(function() {
                        window.location.reload();
                    }, 1500);
                } else {
                    $('#statusMessage').removeClass('d-none alert-success').addClass('alert-danger').text(response.message);
                    btn.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> 刷新数据');
                }
            },
            error: function() {
                $('#statusMessage').removeClass('d-none alert-success').addClass('alert-danger').text('服务器错误，请稍后再试');
                btn.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> 刷新数据');
            }
        });
    });
    
    // 价格分布图 - 只在有storeItems变量时执行
    if (typeof storeItems !== 'undefined' && storeItems.length > 0) {
        (function() {
            // 从JSON中提取价格数据
            var prices = storeItems.map(function(item) {
                return parseFloat(item.price);
            });
            
            // 计算价格范围
            var minPrice = Math.min.apply(null, prices);
            var maxPrice = Math.max.apply(null, prices);
            var range = maxPrice - minPrice;
            
            // 计算区间数量和大小
            var binCount = Math.min(10, Math.ceil(prices.length / 5));
            if (binCount < 3) binCount = 3;
            var binSize = range / binCount;
            
            // 创建区间和频率统计
            var bins = Array(binCount).fill(0);
            var labels = [];
            
            for (var i = 0; i < binCount; i++) {
                var start = minPrice + i * binSize;
                var end = minPrice + (i + 1) * binSize;
                labels.push('$' + start.toFixed(2) + ' - $' + end.toFixed(2));
            }
            
            // 将价格分配到对应区间
            prices.forEach(function(price) {
                var index = Math.min(binCount - 1, Math.floor((price - minPrice) / binSize));
                bins[index]++;
            });
            
            // 绘制图表
            var ctx = document.getElementById('priceChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '商品数量',
                        data: bins,
                        backgroundColor: 'rgba(45, 152, 218, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        })();
    }
});
</script>

<style>
/* 商品缩略图 */
.item-thumbnail {
    max-width: 30px;
    max-height: 30px;
    object-fit: contain;
    border-radius: 3px;
    transition: transform 0.2s;
}

.item-thumbnail:hover {
    transform: scale(2.5);
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

/* 鼠标悬停信息 */
.hover-info {
    color: rgba(255,255,255,0.5);
    transition: color 0.3s ease;
}

.hover-info:hover {
    color: #3498db;
}

/* 表格样式 */
.table tbody tr:nth-child(odd) {
    background-color: rgba(15, 15, 30, 0.6);
}

.table tbody tr:nth-child(even) {
    background-color: rgba(25, 25, 45, 0.6);
}

.table tbody tr:hover {
    background-color: rgba(52, 152, 219, 0.3);
}

/* 价格列右对齐 */
.price-col {
    text-align: right;
}

/* 表格单元格内边距 */
.table td {
    padding: 10px 8px;
    vertical-align: middle;
}
</style>
{% endblock %}